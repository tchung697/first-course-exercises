\documentclass[10pt]{article}
\title{Solutions to Exercises of Chapter 5}
\author{Ting-Chih Hung \\ \href{mailto:nuit0815@gmail.com}{\texttt{nuit0815@gmail.com}}}
\date{\today}

\usepackage{settings}

\begin{document}
\maketitle

\section*{Problem 5.1 (Covariate balance in the CRE)}

Consider a \gls{cre} with $n$ units, 
among which $n_1$ are assigned to treatment ($Z_i = 1$)
and $n_0$ to control ($Z_i = 0$).
Let $X_i \in \bc{1, \ldots, K}$ be the stratum membership of unit $i$,
where $K$ is the number of strata.
Let $n_{[k]} \equiv \sum_{i=1}^n \mathbf{1}\bp{X_i = k}$ be the number of units in stratum $k$,
$\pi_{[k]} \equiv n_{[k]}/n$ be the proportion of units in stratum $k$,
and $n_{[k]z} \equiv \sum_{i=1}^n \mathbf{1}\bp{X_i = k, Z_i = z}$ 
be the number of units in stratum $k$ assigned to treatment $z$.

We are asked to show that
\begin{align}
  \E\bp{\frac{n_{[k]1}}{n_1} - \frac{n_{[k]0}}{n_0}} = 0. \tag{5.2}
\end{align}

This can directly be shown by the following calculation:
\begin{align*}
  &\mathrel{\phantom{=}} \E\bp{\frac{n_{[k]1}}{n_1} - \frac{n_{[k]0}}{n_0}} \\
  &= \E\bp{\frac{n_{[k]1}}{n_1}} - \E\bp{\frac{n_{[k]0}}{n_0}} \tag{Linearity of $\E\bp{\cdot}$} \\
  &= \frac{1}{n_1} \E\bp{\sum_{i = 1}^n Z_i \mathbf{1}\bp{X_i = k}} 
  - \frac{1}{n_0} \E\bp{\sum_{i = 1}^n \bp{1 - Z_i}\mathbf{1}\bp{X_i = k}} 
    \tag{Definition of $n_{[k]z}$} \\
  &= \frac{1}{n_1} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k} \E\bp{Z_i}
  - \frac{1}{n_0} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k} \E\bp{1 - Z_i} 
    \tag{Linearity of $\E\bp{\cdot}$} \\
  &= \frac{1}{n_1} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k} \frac{n_1}{n}
  - \frac{1}{n_0} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k} \frac{n_0}{n} 
    \tag{$\E\bp{Z_i} = n_1/n$ in the \gls{cre}} \\
  &= \frac{1}{n} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k}
  - \frac{1}{n} \sum_{i = 1}^n \mathbf{1}\bp{X_i = k} 
    \tag{Simplification} \\
  &= 0.
\end{align*}

\section*{Problem 5.2 (Consequence of the constant propensity score)}

Following the notation in Problem 5.1,
let $e_{[k]} \equiv n_{[k]1}/n_{[k]}$ be the propensity score of stratum $k$.
Define 
\begin{align*}
  \hat{\tau} &\equiv \frac{1}{n_1} \sum_{i=1}^n Z_i Y_i - \frac{1}{n_0} \sum_{i=1}^n (1 - Z_i) Y_i, \\
  \hat{\tau}_{\text{S}} &\equiv \sum_{k=1}^K \pi_{[k]} \hat{\tau}_{[k]},
\end{align*}
where 
\begin{align*}
  \hat{\tau}_{[k]} 
  \equiv \frac{1}{n_{[k]1}} \sum_{i:X_i = k} Z_i Y_i 
  - \frac{1}{n_{[k]0}} \sum_{i:X_i = k} (1 - Z_i) Y_i.
\end{align*}

We are asked to show that when the propensity score is constant across strata,
\begin{align}
  \hat{\tau} = \hat{\tau}_{\text{S}}. \tag{5.3}
\end{align}

Notice that if the propensity score is constant across strata,
then $e_{[k]} = n_{[k]1}/n_{[k]} = n_1/n$ for all $k = 1, \ldots, K$.
Therefore, we have
\begin{align*}
  &\mathrel{\phantom{=}} \hat{\tau}_{\text{S}} \\
  &\equiv \sum_{k=1}^K \pi_{[k]} \hat{\tau}_{[k]} \tag{Definition of $\hat{\tau}_{\text{S}}$} \\
  &= \sum_{k=1}^K \frac{n_{[k]}}{n} \bp{\frac{1}{n_{[k]1}} \sum_{i:X_i = k} Z_i Y_i - \frac{1}{n_{[k]0}} \sum_{i:X_i = k} (1 - Z_i) Y_i} 
    \tag{Definition of $\pi_{[k]}$ and $\hat{\tau}_{[k]}$} \\
  &= \frac{1}{n} \sum_{k=1}^K \bp{\frac{n_{[k]}}{n_{[k]1}} \sum_{i:X_i = k} Z_i Y_i - \frac{n_{[k]}}{n_{[k]0}} \sum_{i:X_i = k} (1 - Z_i) Y_i} \tag{Factor out $1/n$} \\
  &= \frac{1}{n} \sum_{k=1}^K \bp{ \frac{n}{n_1} \sum_{i:X_i = k} Z_i Y_i - \frac{n}{n_0} \sum_{i:X_i = k} (1 - Z_i) Y_i} 
    \tag{Use $e_{[k]} = n_1/n$} \\
  &= \frac{1}{n_1} \sum_{k=1}^K \sum_{i:X_i = k} Z_i Y_i - \frac{1}{n_0} \sum_{k=1}^K \sum_{i:X_i = k} (1 - Z_i) Y_i \tag{Factor out $n/n_z$} \\
  &= \frac{1}{n_1} \sum_{i=1}^n Z_i Y_i - \frac{1}{n_0} \sum_{i=1}^n (1 - Z_i) Y_i \tag{Combine sums} \\
  &\equiv \hat{\tau}, \tag{Definition of $\hat{\tau}$}
\end{align*}
which completes the proof.

\section*{Problem 5.3 (Consquence of constant individual causal effects)}

\section*{Problem 5.4 (Compare the CRE and SRE)}

We are asked to compare the sampling variance of the difference-in-means estimator
under the \gls{cre} and the \gls{sre}.

Suppose that we have a dataset from a \gls{sre} with $K$ strata.
Assume that $e_{[k]} = n_{[k]1}/n_{[k]}$ is constant across strata.

We are asked to show that
when $n_{[k]}$ is large enough for all $k = 1, \ldots, K$,
the difference between $\Var_{\text{CRE}}\bp{\hat{\tau}}$ 
and $\Var_{\text{SRE}}\bp{\hat{\tau}_\text{S}}$
is always non-negative:
\begin{align*}
  &\mathrel{\phantom{=}} \Var_{\text{CRE}}\bp{\hat{\tau}} - \Var_{\text{SRE}}\bp{\hat{\tau}_\text{S}} \\
  &= \sum_{k=1}^K \bs{
    \frac{\pi_{[k]}}{n_1} \bp{\bar{Y}_{[k]}(1) - \bar{Y}(1)}^2 
    + \frac{\pi_{[k]}}{n_0} \bp{\bar{Y}_{[k]}(0) - \bar{Y}(0)}^2
    - \frac{\pi_{[k]}}{n} \bp{\tau_{[k]} - \tau}^2
  } \geq 0.
\end{align*}

For the simplicity of notation,
let $a_{[k]} \equiv \bar{Y}_{[k]}(1) - \bar{Y}(1)$
and
$b_{[k]} \equiv \bar{Y}_{[k]}(0) - \bar{Y}(0)$.
Then, $a_{[k]} - b_{[k]} = \tau_{[k]} - \tau$.
Therefore, we have
\begin{align*}
  &\mathrel{\phantom{=}} \Var_{\text{CRE}}\bp{\hat{\tau}} - \Var_{\text{SRE}}\bp{\hat{\tau}_\text{S}} \\
  &= \sum_{k=1}^K \bs{
    \frac{\pi_{[k]}}{n_1} a_{[k]}^2 
    + \frac{\pi_{[k]}}{n_0} b_{[k]}^2
    - \frac{\pi_{[k]}}{n} (a_{[k]} - b_{[k]})^2
  } \tag{Substitution} \\
  &= \sum_{k=1}^K \pi_{[k]} \bs{
    \frac{1}{n_1} a_{[k]}^2 
    + \frac{1}{n_0} b_{[k]}^2
    - \frac{1}{n} (a_{[k]}^2 - 2 a_{[k]} b_{[k]} + b_{[k]}^2)
  } \tag{Expand the square} \\
  &= \sum_{k=1}^K \pi_{[k]} \bs{
    \bp{\frac{1}{n_1} - \frac{1}{n}} a_{[k]}^2 
    + \bp{\frac{1}{n_0} - \frac{1}{n}} b_{[k]}^2
    + \frac{2}{n} a_{[k]} b_{[k]}
  } \tag{Rearrangement} \\
  &= \sum_{k=1}^K \pi_{[k]} \bp{
    \frac{n_0}{n n_1} a_{[k]}^2 
    + \frac{n_1}{n n_0} b_{[k]}^2
    + \frac{2}{n} a_{[k]} b_{[k]}
  } \tag{Simplification} \\
  &= \sum_{k=1}^K \frac{\pi_{[k]}}{n} \bp{
    \frac{n_0}{n_1} a_{[k]}^2 
    + \frac{n_1}{n_0} b_{[k]}^2
    + 2 a_{[k]} b_{[k]}
  } \tag{Factor out $1/n$} \\
  &= \sum_{k=1}^K \frac{\pi_{[k]}}{n} \bp{
    \sqrt{\frac{n_0}{n_1}} a_{[k]}
    + \sqrt{\frac{n_1}{n_0}} b_{[k]}
  }^2 \tag{Rewrite the first two terms} \\
  &\geq 0. \tag{Square is non-negative}
\end{align*}
This completes the proof.

\section*{Problem 5.5 (From the CRE to the SRE)}

In a \gls{cre} with $n$ units,
among which $n_1$ are assigned to treatment ($Z_i = 1$)
and $n_0$ to control ($Z_i = 0$).
Suppose that we have a categorical covariate $X_i \in \bc{1, \ldots, K}$,
where $K$ is the number of strata.
Now, the quantities $n_{[k]1}$ and $n_{[k]0}$ will be random variables
because the number of units in stratum $k$ assigned to treatment $z$
will vary across randomizations.
Let $\mathbf{Z} \equiv (Z_1, \ldots, Z_n)$ be the treatment assignment vector,
and $\mathbf{n} \equiv \{n_{[k]1}, n_{[k]0}\}_{k=1}^K$ be the collection of 
the numbers of units in each stratum assigned to treatment and control.

We are asked to show that
\begin{align*}
  P_{\text{CRE}}\bp{\mathbf{Z} = \mathbf{z} \mid \mathbf{n}}
  = \frac{1}{\prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}}}.
\end{align*}
That is, conditional on $\mathbf{n}$,
the treatment assignment $\mathbf{Z}$ is equivalent to that from a \gls{sre}.

Note that
for any realization of $\mathbf{n}$,
the number of possible treatment assignments $\mathbf{z}$
that satisfy $\mathbf{n}$ is exactly
\begin{align*}
  \prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}},
\end{align*}
and each of these treatment assignments
has the same probability $1/\binom{n}{n_1}$
under the \gls{cre}.
Therefore, we have
\begin{align*}
  &\mathrel{\phantom{=}} P_{\text{CRE}}\bp{\mathbf{Z} = \mathbf{z} \mid \mathbf{n}} \\
  &= \frac{P_{\text{CRE}}\bp{\mathbf{Z} = \mathbf{z}, \mathbf{n}}}{P_{\text{CRE}}\bp{\mathbf{n}}} \tag{Definition of conditional probability} \\
  &= \frac{P_{\text{CRE}}\bp{\mathbf{Z} = \mathbf{z}}}{P_{\text{CRE}}\bp{\mathbf{n}}} \tag{$\mathbf{n}$ is determined by $\mathbf{Z}$} \\
  &= \frac{\frac{1}{\binom{n}{n_1}}}{\frac{\prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}}}{\binom{n}{n_1}}} 
    \tag{$P_{\text{CRE}}\bp{\mathbf{Z} = \mathbf{z}} = 1/\binom{n}{n_1}$ and $P_{\text{CRE}}\bp{\mathbf{n}} = {\prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}}}/{\binom{n}{n_1}}$} \\
  &= \frac{1}{\prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}}},
\end{align*}
which completes the proof.


\section*{Problem 5.6 (More FRTs for Section 5.2.2)}

\printglossaries
\end{document}
